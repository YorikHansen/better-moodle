name: build.yml
on:
    push:
        branches:
            - v2
    pull_request:
        branches:
            - v2

jobs:
    build:
        runs-on: ubuntu-latest
        name: 🏗️ Build
        strategy:
            matrix:
                config:
                    - uzl
                    - cau
        env:
            dist_dir: dist
            dist_file: better-moodle-${{ matrix.config }}.user.js
        permissions:
            id-token: write
            attestations: write
        steps:
            - name: 📥️ checkout
              uses: actions/checkout@v4

            - name: 🎛️ setup
              uses: ./.github/actions/setup

            - name: 🏗️ build Better-Moodle for ${{ matrix.config }}
              run: yarn build ${{ matrix.config }}

            - name: 📤️ upload build
              id: upload
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.dist_file }}
                  path: ${{ env.dist_dir }}/${{ env.dist_file }}

            - name: 🦭 attest build provenance
              uses: actions/attest-build-provenance@v2
              with:
                  subject-name: ${{ env.dist_file }}
                  subject-digest: sha256:${{ steps.upload.outputs.artifact-digest }}
                  show-summary: true

            - name: 📊 aggregate build statistics
              run: |
                  echo "STATS_SIZE=$(ls -sh --si '${{ env.dist_dir }}/${{ env.dist_file }}' | awk '{print $1}')B" >> $GITHUB_ENV
                  echo "STATS_LINES=$(wc -l '${{ env.dist_dir }}/${{ env.dist_file }}' | awk '{print $1}')" >> $GITHUB_ENV

            # TODO: Output build stats
            - name: ✍️ print build stats in summary
              run: |
                  echo "# 🏗️ ${{ matrix.config }}" >> $GITHUB_STEP_SUMMARY
                  echo "## Built file: \`${{ env.dist_file }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------:|:------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **File size** | ${{ env.STATS_SIZE }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Line count** | ${{ env.STATS_LINES }} |" >> $GITHUB_STEP_SUMMARY

                  echo "## Build stats" >> $GITHUB_STEP_SUMMARY
                  echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------:|:------|" >> $GITHUB_STEP_SUMMARY
                  echo "| **Creating config duration** | $(cat ${{ env.dist_dir }}/.stats_perf_conf) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Building duration** | $(cat ${{ env.dist_dir }}/.stats_perf_build) |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Total duration** | $(cat ${{ env.dist_dir }}/.stats_perf_total) |" >> $GITHUB_STEP_SUMMARY
                  echo "*Durations are mm:ss,s*"

                  echo "## Included features" >> $GITHUB_STEP_SUMMARY
                  cat ${{ env.dist_dir }}/.stats_features.md >> $GITHUB_STEP_SUMMARY
